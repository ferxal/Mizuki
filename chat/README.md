# WebSocket èŠå¤©å®¤

åŸºäº uWebSockets.js çš„é«˜æ€§èƒ½å®æ—¶èŠå¤©å®¤åº”ç”¨ã€‚

## ç‰¹æ€§

- âš¡ **é«˜æ€§èƒ½**: ä½¿ç”¨ uWebSockets.jsï¼Œæ”¯æŒå¤§é‡å¹¶å‘è¿æ¥
- ğŸ’¬ **å®æ—¶é€šä¿¡**: WebSocket åŒå‘é€šä¿¡ï¼Œæ¶ˆæ¯å³æ—¶é€è¾¾
- ğŸ‘¥ **ç”¨æˆ·ç®¡ç†**: æ˜µç§°è®¾ç½®ã€åœ¨çº¿ç”¨æˆ·åˆ—è¡¨ã€åŠ å…¥/ç¦»å¼€é€šçŸ¥
- ğŸ”’ **ç§èŠåŠŸèƒ½**: æ”¯æŒç‚¹å¯¹ç‚¹ç§èŠ
- ğŸ’“ **å¿ƒè·³æœºåˆ¶**: è‡ªåŠ¨æ£€æµ‹å¹¶æ¸…ç†æ‰çº¿ç”¨æˆ·
- ğŸ“± **å“åº”å¼ç•Œé¢**: é€‚é…ç§»åŠ¨ç«¯å’Œæ¡Œé¢ç«¯
- ğŸš€ **é›¶æ•°æ®åº“**: çº¯å†…å­˜å­˜å‚¨ï¼Œéƒ¨ç½²ç®€å•

## å¿«é€Ÿå¼€å§‹

### å®‰è£…ä¾èµ–

```bash
pnpm install
```

### å¯åŠ¨æœåŠ¡å™¨

```bash
pnpm start
```

æˆ–å¼€å‘æ¨¡å¼ï¼ˆæ”¯æŒæ–‡ä»¶ç›‘å¬ï¼‰ï¼š

```bash
pnpm dev
```

æœåŠ¡å™¨å°†åœ¨ `http://localhost:11451` å¯åŠ¨ã€‚

## ä½¿ç”¨è¯´æ˜

### æµè§ˆå™¨è®¿é—®

æ‰“å¼€æµè§ˆå™¨è®¿é—® `http://localhost:11451`ï¼Œå³å¯çœ‹åˆ°èŠå¤©å®¤ç•Œé¢ã€‚

### WebSocket API

#### è¿æ¥

```javascript
const ws = new WebSocket('ws://localhost:11451');
```

#### æ¶ˆæ¯æ ¼å¼

##### 1. è®¾ç½®æ˜µç§°
```json
{
  "type": "set_nickname",
  "nickname": "ç”¨æˆ·å"
}
```

##### 2. å‘é€å…¬å…±æ¶ˆæ¯
```json
{
  "type": "public",
  "content": "æ¶ˆæ¯å†…å®¹"
}
```

##### 3. å‘é€ç§èŠ
```json
{
  "type": "private",
  "target": "ç›®æ ‡ç”¨æˆ·æ˜µç§°",
  "content": "æ¶ˆæ¯å†…å®¹"
}
```

##### 4. å¿ƒè·³
```json
{
  "type": "heartbeat"
}
```

##### 5. è·å–ç”¨æˆ·åˆ—è¡¨
```json
{
  "type": "get_users"
}
```

#### æ¥æ”¶æ¶ˆæ¯ç±»å‹

- `system`: ç³»ç»Ÿæ¶ˆæ¯
- `nickname_set`: æ˜µç§°è®¾ç½®æˆåŠŸ
- `join`: ç”¨æˆ·åŠ å…¥
- `leave`: ç”¨æˆ·ç¦»å¼€
- `public`: å…¬å…±æ¶ˆæ¯
- `private`: ç§èŠæ¶ˆæ¯
- `user_list`: ç”¨æˆ·åˆ—è¡¨æ›´æ–°
- `error`: é”™è¯¯ä¿¡æ¯
- `heartbeat`: å¿ƒè·³å“åº”

## æŠ€æœ¯æ¶æ„

- **åç«¯**: Node.js + uWebSockets.js
- **å‰ç«¯**: åŸç”Ÿ HTML/CSS/JavaScript
- **é€šä¿¡**: WebSocket
- **å­˜å‚¨**: å†…å­˜ï¼ˆMap æ•°æ®ç»“æ„ï¼‰

## æ€§èƒ½ä¼˜åŒ–

- ä½¿ç”¨ uWebSockets.js è·å¾—æ¥è¿‘åŸç”Ÿçš„æ€§èƒ½
- æ¶ˆæ¯å‹ç¼©ï¼ˆSHARED_COMPRESSORï¼‰
- å¿ƒè·³æœºåˆ¶é¿å…åƒµå°¸è¿æ¥
- æ¶ˆæ¯å¤§å°é™åˆ¶ï¼ˆ16KBï¼‰
- ç©ºé—²è¶…æ—¶è‡ªåŠ¨æ–­å¼€ï¼ˆ120ç§’ï¼‰

## éƒ¨ç½²å»ºè®®

### å®¶åº­æœåŠ¡å™¨

1. ç¡®ä¿é˜²ç«å¢™å¼€æ”¾ 11451 ç«¯å£
2. å¦‚éœ€å¤–ç½‘è®¿é—®ï¼Œé…ç½®è·¯ç”±å™¨ç«¯å£è½¬å‘
3. å»ºè®®ä½¿ç”¨ PM2 æˆ– systemd ç®¡ç†è¿›ç¨‹

### ä½¿ç”¨ PM2

```bash
# å®‰è£… PM2
pnpm add -g pm2

# å¯åŠ¨
pm2 start server.js --name chat-server

# æŸ¥çœ‹æ—¥å¿—
pm2 logs chat-server

# ä¿å­˜é…ç½®
pm2 save
pm2 startup
```

### åå‘ä»£ç†ï¼ˆNginxï¼‰

```nginx
location /chat {
    proxy_pass http://localhost:11451;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
}
```

## å®‰å…¨å»ºè®®

- ç”Ÿäº§ç¯å¢ƒå»ºè®®æ·»åŠ æ¶ˆæ¯å†…å®¹è¿‡æ»¤
- å¯ä»¥æ·»åŠ é€Ÿç‡é™åˆ¶é˜²æ­¢åˆ·å±
- è€ƒè™‘æ·»åŠ ç”¨æˆ·è®¤è¯æœºåˆ¶
- ä½¿ç”¨ WSSï¼ˆWebSocket Secureï¼‰åŠ å¯†ä¼ è¾“

## é¡¹ç›®ç»“æ„

```
chat/
â”œâ”€â”€ package.json      # é¡¹ç›®é…ç½®
â”œâ”€â”€ server.js         # æœåŠ¡å™¨ä¸»ç¨‹åº
â”œâ”€â”€ index.html        # æµ‹è¯•é¡µé¢
â””â”€â”€ README.md         # è¯´æ˜æ–‡æ¡£
```

## å¼€å‘è®¡åˆ’

- [ ] æ¶ˆæ¯å†å²è®°å½•
- [ ] è¡¨æƒ…æ”¯æŒ
- [ ] æ–‡ä»¶ä¼ è¾“
- [ ] è¯­éŸ³/è§†é¢‘é€šè¯
- [ ] æˆ¿é—´/é¢‘é“åŠŸèƒ½
- [ ] ç”¨æˆ·è®¤è¯
- [ ] æ¶ˆæ¯åŠ å¯†

## License

MIT
