---
import { siteConfig } from "../config";
import I18nKey from "../i18n/i18nKey";
import { i18n } from "../i18n/translation";
import MainGridLayout from "../layouts/MainGridLayout.astro";

// æ£€æŸ¥èŠå¤©å®¤é¡µé¢æ˜¯å¦å¯ç”¨
if (!siteConfig.featurePages.chat) {
	return Astro.redirect("/404/");
}

// èŠå¤©å®¤é…ç½®
const chatConfig = siteConfig.chat || {
	serverUrl: 'ws://localhost:11451',
	maxMessageLength: 1000,
	maxNicknameLength: 20,
	enableStats: true
};

const wsUrl = chatConfig.serverUrl;
---

<MainGridLayout title={i18n(I18nKey.chat)} description="å®æ—¶èŠå¤©å®¤">
	<div class="flex w-full rounded-[var(--radius-large)] overflow-hidden relative">
		<div class="card-base z-10 w-full">
			<!-- é¡µé¢æ ‡é¢˜ -->
			<div class="px-6 md:px-9 py-6 border-b border-black/10 dark:border-white/10">
				<h1 class="text-3xl md:text-4xl font-bold text-black/90 dark:text-white/90 mb-2 relative
							before:w-1 before:h-8 before:rounded-md before:bg-[var(--primary)]
							before:absolute before:top-1/2 before:-translate-y-1/2 before:-left-4">
					ğŸ’¬ {i18n(I18nKey.chat)}
				</h1>
				<p class="text-base md:text-lg text-black/60 dark:text-white/60">
					å®æ—¶èŠå¤©ï¼Œå³æ—¶äº¤æµ
				</p>
			</div>

			<!-- èŠå¤©å®¤ä¸»ä½“ -->
			<div class="flex flex-col lg:flex-row h-[calc(100vh-20rem)] min-h-[600px]">
				<!-- ä¾§è¾¹æ ï¼šåœ¨çº¿ç”¨æˆ· -->
				<div class="w-full lg:w-64 border-b lg:border-b-0 lg:border-r border-black/10 dark:border-white/10 
							flex flex-col bg-[var(--btn-regular-bg)]/30">
					<!-- ä¾§è¾¹æ æ ‡é¢˜ -->
					<div class="px-4 py-3 border-b border-black/10 dark:border-white/10 flex items-center justify-between">
						<h3 class="text-sm font-semibold text-black/70 dark:text-white/70 uppercase tracking-wide">
							åœ¨çº¿ç”¨æˆ· (<span id="user-count">0</span>)
						</h3>
						<button 
							id="logout-btn"
							title="é€€å‡ºç™»å½•"
							class="text-xs px-2 py-1 rounded bg-red-500/10 text-red-600 dark:text-red-400
								   hover:bg-red-500/20 transition-all duration-200 flex items-center gap-1"
						>
							<svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
								<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
									  d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
							</svg>
							é€€å‡º
						</button>
					</div>

					<!-- ç”¨æˆ·åˆ—è¡¨ -->
					<div class="flex-1 overflow-y-auto p-3 space-y-1" id="user-list">
						<!-- åŠ¨æ€ç”Ÿæˆ -->
					</div>

					<!-- ç»Ÿè®¡ä¿¡æ¯ -->
					{chatConfig.enableStats && (
						<div class="px-4 py-3 border-t border-black/10 dark:border-white/10 text-xs text-black/50 dark:text-white/50 space-y-1">
							<div class="flex justify-between">
								<span>æ¶ˆæ¯æ€»æ•°:</span>
								<span id="message-count">0</span>
							</div>
							<div class="flex justify-between">
								<span>è¿æ¥çŠ¶æ€:</span>
								<span id="connection-status">æœªè¿æ¥</span>
							</div>
						</div>
					)}
				</div>

				<!-- èŠå¤©åŒºåŸŸ -->
				<div class="flex-1 flex flex-col">
					<!-- æ¶ˆæ¯åŒºåŸŸ -->
					<div class="flex-1 overflow-y-auto p-4 space-y-3" id="messages">
						<!-- æ¬¢è¿æ¶ˆæ¯ -->
						<div class="text-center py-8">
							<div class="inline-block px-4 py-2 rounded-lg bg-[var(--primary)]/10 text-[var(--primary)] text-sm">
								æ¬¢è¿æ¥åˆ°èŠå¤©å®¤ï¼è¯·è¾“å…¥æ˜µç§°å¼€å§‹èŠå¤© ğŸ“¨
							</div>
						</div>
					</div>

					<!-- è¾“å…¥åŒºåŸŸ -->
					<div class="p-4 border-t border-black/10 dark:border-white/10 bg-[var(--btn-regular-bg)]/30">
						<div class="flex gap-2">
							<input 
								type="text" 
								id="message-input"
								placeholder="è¾“å…¥æ¶ˆæ¯..."
								disabled
								maxlength={chatConfig.maxMessageLength}
								class="flex-1 px-4 py-3 rounded-lg bg-white dark:bg-[var(--card-bg)]
									   text-black/90 dark:text-white/90
									   border border-black/10 dark:border-white/10
									   focus:outline-none focus:ring-2 focus:ring-[var(--primary)]/50
									   disabled:opacity-50 disabled:cursor-not-allowed
									   transition-all duration-200"
							/>
							<button 
								id="send-btn"
								disabled
								class="px-6 py-3 rounded-lg bg-[var(--primary)] text-white 
									   hover:bg-[var(--primary)]/90 active:scale-95
									   disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:bg-[var(--primary)]
									   transition-all duration-200 font-medium
									   flex items-center gap-2"
							>
								<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
									<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
								</svg>
								<span class="hidden sm:inline">å‘é€</span>
							</button>
						</div>
						<div class="mt-2 text-xs text-black/50 dark:text-white/50">
							æŒ‰ Enter å‘é€ï¼ŒShift+Enter æ¢è¡Œ
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>

	<!-- å¯†ç éªŒè¯æ¨¡æ€æ¡† -->
	<div id="password-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
		<div class="card-base max-w-md w-full p-6 md:p-8 animate-fadeInUp">
			<h2 class="text-2xl font-bold text-black/90 dark:text-white/90 mb-4">
				ğŸ”’ èŠå¤©å®¤å¯†ç éªŒè¯
			</h2>
			<p class="text-sm text-black/60 dark:text-white/60 mb-6">
				è¯·è¾“å…¥å¯†ç ä»¥è®¿é—®èŠå¤©å®¤
			</p>
			<input 
				type="password" 
				id="password-input"
				placeholder="è¯·è¾“å…¥èŠå¤©å®¤å¯†ç "
				class="w-full px-4 py-3 rounded-lg mb-4
					   bg-white dark:bg-[var(--card-bg)]
					   text-black/90 dark:text-white/90
					   border border-black/10 dark:border-white/10
					   focus:outline-none focus:ring-2 focus:ring-[var(--primary)]/50
					   transition-all duration-200"
			/>
			<div id="password-error" class="hidden text-sm text-red-500 mb-4">
				å¯†ç é”™è¯¯ï¼Œè¯·é‡è¯•
			</div>
			<button 
				id="password-btn"
				class="w-full px-6 py-3 rounded-lg bg-[var(--primary)] text-white 
					   hover:bg-[var(--primary)]/90 active:scale-95
					   transition-all duration-200 font-medium"
			>
				éªŒè¯
			</button>
		</div>
	</div>

	<!-- æ˜µç§°è®¾ç½®æ¨¡æ€æ¡† -->
	<div id="nickname-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 hidden">
		<div class="flex items-center justify-center min-h-screen p-4">
			<div class="card-base max-w-md w-full p-6 md:p-8 animate-fadeInUp">
				<h2 class="text-2xl font-bold text-black/90 dark:text-white/90 mb-4">
					è®¾ç½®æ˜µç§°
				</h2>
				<p class="text-sm text-black/60 dark:text-white/60 mb-6">
					è¯·è¾“å…¥ä¸€ä¸ªæ˜µç§°ä»¥åŠ å…¥èŠå¤©å®¤
				</p>
				<input 
					type="text" 
					id="nickname-input"
					placeholder="è¾“å…¥æ˜µç§°"
					class="w-full px-4 py-3 rounded-lg mb-4
						   bg-white dark:bg-[var(--card-bg)]
						   text-black/90 dark:text-white/90
						   border border-black/10 dark:border-white/10
						   focus:outline-none focus:ring-2 focus:ring-[var(--primary)]/50
						   transition-all duration-200"
				/>
				<button 
					id="join-btn"
					class="w-full px-6 py-3 rounded-lg bg-[var(--primary)] text-white 
						   hover:bg-[var(--primary)]/90 active:scale-95
						   transition-all duration-200 font-medium"
				>
					åŠ å…¥èŠå¤©
				</button>
			</div>
		</div>
	</div>
</MainGridLayout>

<script define:vars={{ wsUrl, maxMessageLength: chatConfig.maxMessageLength, maxNicknameLength: chatConfig.maxNicknameLength }}>
	// å¯†ç å“ˆå¸Œï¼ˆSHA-256ï¼‰- ferxal666çš„å“ˆå¸Œå€¼
	const PASSWORD_HASH = '879358bf7efd25c56e4d09600de1411efd44d9aa4784013190c740b55f0441d7';
	const AUTH_STORAGE_KEY = 'chat_auth_token';
	
	// SHA-256å“ˆå¸Œå‡½æ•°
	async function sha256(message) {
		const msgBuffer = new TextEncoder().encode(message);
		const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
		const hashArray = Array.from(new Uint8Array(hashBuffer));
		return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
	}

	// æ£€æŸ¥è®¤è¯çŠ¶æ€
	function checkAuth() {
		try {
			const stored = localStorage.getItem(AUTH_STORAGE_KEY);
			return stored === PASSWORD_HASH;
		} catch (e) {
			return false;
		}
	}

	// ä¿å­˜è®¤è¯çŠ¶æ€
	function saveAuth() {
		try {
			localStorage.setItem(AUTH_STORAGE_KEY, PASSWORD_HASH);
		} catch (e) {
			console.error('æ— æ³•ä¿å­˜è®¤è¯çŠ¶æ€');
		}
	}

	// æ¸…é™¤è®¤è¯çŠ¶æ€
	function clearAuth() {
		try {
			localStorage.removeItem(AUTH_STORAGE_KEY);
		} catch (e) {
			console.error('æ— æ³•æ¸…é™¤è®¤è¯çŠ¶æ€');
		}
	}

	let ws = null;
	let isAuthenticated = checkAuth();
	let connected = false;
	let nickname = null;
	let selectedUser = null;
	let messageCount = 0;

	const elements = {
		passwordModal: document.getElementById('password-modal'),
		passwordInput: document.getElementById('password-input'),
		passwordBtn: document.getElementById('password-btn'),
		passwordError: document.getElementById('password-error'),
		nicknameModal: document.getElementById('nickname-modal'),
		nicknameInput: document.getElementById('nickname-input'),
		joinBtn: document.getElementById('join-btn'),
		messageInput: document.getElementById('message-input'),
		sendBtn: document.getElementById('send-btn'),
		messages: document.getElementById('messages'),
		userList: document.getElementById('user-list'),
		userCount: document.getElementById('user-count'),
		messageCountEl: document.getElementById('message-count'),
		connectionStatus: document.getElementById('connection-status'),
		logoutBtn: document.getElementById('logout-btn')
	};

	// è®¾ç½®åŠ¨æ€placeholder
	if (elements.nicknameInput) {
		elements.nicknameInput.placeholder = `è¾“å…¥æ˜µç§° (2-${maxNicknameLength}ä¸ªå­—ç¬¦)`;
	}

	// æ ¼å¼åŒ–æ—¶é—´
	function formatTime(timestamp) {
		const date = new Date(timestamp);
		return date.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
	}

	// æ·»åŠ æ¶ˆæ¯åˆ°èŠå¤©åŒº
	function addMessage(type, content, from = null, to = null, timestamp = Date.now()) {
		const messageDiv = document.createElement('div');
		messageDiv.className = 'animate-fadeInUp';

		if (type === 'system' || type === 'join' || type === 'leave') {
			messageDiv.innerHTML = `
				<div class="text-center">
					<span class="inline-block px-3 py-1 rounded-lg bg-[var(--btn-regular-bg)] text-black/60 dark:text-white/60 text-sm">
						${content} <span class="text-xs opacity-70">${formatTime(timestamp)}</span>
					</span>
				</div>
			`;
		} else if (type === 'public') {
			const isOwn = from === nickname;
			messageDiv.innerHTML = `
				<div class="flex ${isOwn ? 'justify-end' : 'justify-start'}">
					<div class="max-w-[70%] ${isOwn ? 'items-end' : 'items-start'} flex flex-col gap-1">
						<div class="text-xs text-black/50 dark:text-white/50 px-2 animate-fadeInUp" style="animation-delay: 0.05s;">
							${from} ${isOwn ? '(ä½ )' : ''}
						</div>
						<div class="message-bubble ${isOwn ? 'bg-[var(--primary)] text-white' : 'bg-[var(--btn-regular-bg)] text-black/90 dark:text-white/90'} 
									px-4 py-2 rounded-2xl break-words transition-all duration-200 hover:shadow-lg">
							${escapeHtml(content)}
						</div>
						<div class="text-xs text-black/40 dark:text-white/40 px-2 animate-fadeInUp" style="animation-delay: 0.1s;">
							${formatTime(timestamp)}
						</div>
					</div>
				</div>
			`;
		} else if (type === 'private') {
			const label = to ? `å‘ç»™ ${to}` : `æ¥è‡ª ${from}`;
			messageDiv.innerHTML = `
				<div class="flex justify-start">
					<div class="max-w-[70%] flex flex-col gap-1">
						<div class="text-xs text-[var(--primary)] px-2 animate-fadeInUp" style="animation-delay: 0.05s;">
							ğŸ”’ ${label}
						</div>
						<div class="message-bubble bg-orange-500/10 dark:bg-orange-500/20 border border-orange-500/30
									text-black/90 dark:text-white/90 px-4 py-2 rounded-2xl break-words transition-all duration-200 hover:shadow-lg hover:border-orange-500/50">
							${escapeHtml(content)}
						</div>
						<div class="text-xs text-black/40 dark:text-white/40 px-2 animate-fadeInUp" style="animation-delay: 0.1s;">
							${formatTime(timestamp)}
						</div>
					</div>
				</div>
			`;
		}

		elements.messages.appendChild(messageDiv);
		elements.messages.scrollTop = elements.messages.scrollHeight;
		messageCount++;
		if (elements.messageCountEl) {
			elements.messageCountEl.textContent = messageCount;
		}
	}

	// HTMLè½¬ä¹‰
	function escapeHtml(text) {
		const div = document.createElement('div');
		div.textContent = text;
		return div.innerHTML;
	}

	// æ›´æ–°ç”¨æˆ·åˆ—è¡¨
	function updateUserList(users) {
		elements.userCount.textContent = users.length;
		elements.userList.innerHTML = '';

		// æ·»åŠ "æ‰€æœ‰äºº"é€‰é¡¹
		const allItem = createUserItem('æ‰€æœ‰äºº', 'ğŸŒ', true);
		allItem.onclick = () => {
			selectedUser = null;
			updateUserSelection();
			elements.messageInput.placeholder = 'è¾“å…¥æ¶ˆæ¯...';
		};
		elements.userList.appendChild(allItem);

		// æ·»åŠ ç”¨æˆ·
		users.forEach(user => {
			if (user.nickname === nickname) return;
			const userItem = createUserItem(user.nickname, 'ğŸ‘¤', false);
			userItem.onclick = () => {
				selectedUser = user.nickname;
				updateUserSelection();
				elements.messageInput.placeholder = `å‘é€ç§èŠç»™ ${user.nickname}...`;
			};
			elements.userList.appendChild(userItem);
		});
	}

	function createUserItem(name, icon, isSelected) {
		const div = document.createElement('div');
		div.className = `px-3 py-2 rounded-lg cursor-pointer transition-all duration-200
						 ${isSelected ? 'bg-[var(--primary)] text-white' : 'hover:bg-[var(--btn-regular-bg-hover)] text-black/70 dark:text-white/70'}
						 user-item`;
		div.innerHTML = `<span class="text-sm">${icon} ${name}</span>`;
		return div;
	}

	function updateUserSelection() {
		document.querySelectorAll('.user-item').forEach(item => {
			item.classList.remove('bg-[var(--primary)]', 'text-white');
			item.classList.add('hover:bg-[var(--btn-regular-bg-hover)]', 'text-black/70', 'dark:text-white/70');
		});
	}

	// è¿æ¥WebSocket
	function connect() {
		ws = new WebSocket(wsUrl);

		ws.onopen = () => {
			connected = true;
			if (elements.connectionStatus) {
				elements.connectionStatus.textContent = 'å·²è¿æ¥';
				elements.connectionStatus.className = 'text-green-500';
			}
		};

		ws.onmessage = (event) => {
			try {
				const data = JSON.parse(event.data);

				switch(data.type) {
					case 'system':
						addMessage('system', data.message, null, null, data.timestamp);
						break;

					case 'nickname_set':
						nickname = data.nickname;
						elements.nicknameModal.classList.add('hidden');
						elements.messageInput.disabled = false;
						elements.sendBtn.disabled = false;
						addMessage('system', `ä½ å·²åŠ å…¥èŠå¤©å®¤ï¼Œæ˜µç§°: ${nickname}`, null, null, data.timestamp);
						break;

					case 'join':
						addMessage('join', `${data.nickname} åŠ å…¥äº†èŠå¤©å®¤`, null, null, data.timestamp);
						break;

					case 'leave':
						addMessage('leave', `${data.nickname} ç¦»å¼€äº†èŠå¤©å®¤`, null, null, data.timestamp);
						if (selectedUser === data.nickname) {
							selectedUser = null;
							elements.messageInput.placeholder = 'è¾“å…¥æ¶ˆæ¯...';
						}
						break;

					case 'public':
						addMessage('public', data.content, data.nickname, null, data.timestamp);
						break;

					case 'private':
						addMessage('private', data.content, data.from, data.to, data.timestamp);
						break;

					case 'user_list':
						updateUserList(data.users);
						break;

					case 'error':
						addMessage('system', `âŒ ${data.message}`, null, null, data.timestamp);
						break;

					case 'heartbeat':
						break;
				}
			} catch (err) {
				console.error('å¤„ç†æ¶ˆæ¯é”™è¯¯:', err);
			}
		};

		ws.onerror = (error) => {
			console.error('WebSocketé”™è¯¯:', error);
			addMessage('system', 'è¿æ¥é”™è¯¯ï¼Œè¯·æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€');
		};

		ws.onclose = () => {
			connected = false;
			if (elements.connectionStatus) {
				elements.connectionStatus.textContent = 'æœªè¿æ¥';
				elements.connectionStatus.className = 'text-red-500';
			}
			elements.messageInput.disabled = true;
			elements.sendBtn.disabled = true;
			addMessage('system', 'è¿æ¥å·²æ–­å¼€ï¼Œ5ç§’åå°è¯•é‡è¿...');

			setTimeout(() => {
				if (!connected) {
					addMessage('system', 'æ­£åœ¨é‡æ–°è¿æ¥...');
					connect();
				}
			}, 5000);
		};

		// å¿ƒè·³
		setInterval(() => {
			if (connected && ws.readyState === WebSocket.OPEN) {
				ws.send(JSON.stringify({ type: 'heartbeat' }));
			}
		}, 30000);
	}

	// å‘é€æ¶ˆæ¯
	function sendMessage() {
		const content = elements.messageInput.value.trim();
		if (!content || !connected) return;

		if (content.length > maxMessageLength) {
			addMessage('system', `æ¶ˆæ¯é•¿åº¦ä¸èƒ½è¶…è¿‡${maxMessageLength}å­—ç¬¦`);
			return;
		}

		const message = {
			type: selectedUser ? 'private' : 'public',
			content
		};

		if (selectedUser) {
			message.target = selectedUser;
		}

		ws.send(JSON.stringify(message));
		elements.messageInput.value = '';
	}

	// è®¾ç½®æ˜µç§°
	elements.joinBtn.onclick = () => {
		const name = elements.nicknameInput.value.trim();
		if (name.length < 2 || name.length > 20) {
			alert('æ˜µç§°é•¿åº¦å¿…é¡»åœ¨2-20ä¸ªå­—ç¬¦ä¹‹é—´');
			return;
		}

		// ç­‰å¾… WebSocket è¿æ¥å»ºç«‹
		if (!ws || ws.readyState !== WebSocket.OPEN) {
			addMessage('system', 'æ­£åœ¨è¿æ¥æœåŠ¡å™¨ï¼Œè¯·ç¨å€™...');
			// ç­‰å¾…è¿æ¥å»ºç«‹åå†å‘é€
			const checkConnection = setInterval(() => {
				if (ws && ws.readyState === WebSocket.OPEN) {
					clearInterval(checkConnection);
					ws.send(JSON.stringify({
						type: 'set_nickname',
						nickname: name
					}));
				}
			}, 100);
			// 5ç§’è¶…æ—¶
			setTimeout(() => clearInterval(checkConnection), 5000);
			return;
		}

		ws.send(JSON.stringify({
			type: 'set_nickname',
			nickname: name
		}));
	};

	// å‘é€æŒ‰é’®
	elements.sendBtn.onclick = sendMessage;

	// å›è½¦å‘é€
	elements.messageInput.onkeypress = (e) => {
		if (e.key === 'Enter' && !e.shiftKey) {
			e.preventDefault();
			sendMessage();
		}
	};

	elements.nicknameInput.onkeypress = (e) => {
		if (e.key === 'Enter') {
			elements.joinBtn.click();
		}
	};

	// å¯†ç éªŒè¯
	elements.passwordBtn.onclick = async () => {
		const password = elements.passwordInput.value;
		const hash = await sha256(password);
		
		if (hash === PASSWORD_HASH) {
			isAuthenticated = true;
			saveAuth(); // ä¿å­˜è®¤è¯çŠ¶æ€
			
			// æ·»åŠ é€€å‡ºåŠ¨ç”»
			elements.passwordModal.style.animation = 'fadeOut 0.3s ease-out';
			setTimeout(() => {
				elements.passwordModal.classList.add('hidden');
				elements.passwordModal.style.animation = '';
				elements.nicknameModal.classList.remove('hidden');
				elements.nicknameInput.focus();
			}, 300);
			
			elements.passwordError.classList.add('hidden');
			connect();
		} else {
			// æŠ–åŠ¨åŠ¨ç”»
			elements.passwordError.classList.remove('hidden');
			elements.passwordInput.style.animation = 'shake 0.5s';
			setTimeout(() => {
				elements.passwordInput.style.animation = '';
			}, 500);
			elements.passwordInput.value = '';
			elements.passwordInput.focus();
		}
	};

	elements.passwordInput.onkeypress = (e) => {
		if (e.key === 'Enter') {
			elements.passwordBtn.click();
		}
	};

	// é€€å‡ºç™»å½•
	if (elements.logoutBtn) {
		elements.logoutBtn.onclick = () => {
			if (confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ')) {
				// æ–­å¼€è¿æ¥
				if (ws && ws.readyState !== WebSocket.CLOSED) {
					ws.close();
				}
				
				// æ¸…é™¤è®¤è¯çŠ¶æ€
				clearAuth();
				
				// é‡ç½®çŠ¶æ€
				isAuthenticated = false;
				connected = false;
				nickname = null;
				
				// æ˜¾ç¤ºå¯†ç éªŒè¯æ¡†
				elements.nicknameModal.classList.add('hidden');
				elements.passwordModal.classList.remove('hidden');
				elements.passwordInput.value = '';
				elements.passwordInput.focus();
				
				// æ¸…ç©ºæ¶ˆæ¯å’Œç”¨æˆ·åˆ—è¡¨
				elements.messages.innerHTML = '';
				elements.userList.innerHTML = '';
				elements.userCount.textContent = '0';
				
				// ç¦ç”¨è¾“å…¥
				elements.messageInput.disabled = true;
				elements.sendBtn.disabled = true;
			}
		};
	}

	// åˆå§‹åŒ–
	if (isAuthenticated) {
		// å·²è®¤è¯ï¼Œç›´æ¥æ˜¾ç¤ºæ˜µç§°è®¾ç½®
		elements.passwordModal.classList.add('hidden');
		elements.nicknameModal.classList.remove('hidden');
		if (elements.nicknameInput) {
			elements.nicknameInput.focus();
		}
		connect();
	} else {
		// æœªè®¤è¯ï¼Œæ˜¾ç¤ºå¯†ç éªŒè¯
		if (elements.passwordInput) {
			elements.passwordInput.focus();
		}
	}
</script>

<!-- Swup é¡µé¢åˆ‡æ¢æ”¯æŒ -->
<script is:inline>
	// èŠå¤©å®¤é¡µé¢åˆå§‹åŒ–å‡½æ•°
	function initChatPage() {
		// æ£€æŸ¥æ˜¯å¦åœ¨èŠå¤©å®¤é¡µé¢
		if (!document.getElementById('password-modal')) return;

		// å¦‚æœå·²ç»æœ‰è¿æ¥ï¼Œæ–­å¼€ä»¥é‡æ–°åˆå§‹åŒ–
		const existingWs = window.chatWs;
		if (existingWs && existingWs.readyState !== WebSocket.CLOSED) {
			existingWs.close();
		}

		// é¡µé¢å·²ç»é€šè¿‡ä¸Šé¢çš„ä¸»è„šæœ¬åˆå§‹åŒ–
		console.log('èŠå¤©å®¤é¡µé¢åˆå§‹åŒ–å®Œæˆ');
	}

	// é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
	if (document.readyState === 'loading') {
		document.addEventListener('DOMContentLoaded', initChatPage);
	} else {
		initChatPage();
	}

	// Swup é¡µé¢åˆ‡æ¢æ”¯æŒ
	if (typeof window !== 'undefined') {
		window.addEventListener('load', () => {
			if (window.swup) {
				window.swup.hooks.on('page:view', () => {
					// å½“åˆ‡æ¢åˆ°èŠå¤©å®¤é¡µé¢æ—¶é‡æ–°åˆå§‹åŒ–
					if (document.getElementById('password-modal')) {
						initChatPage();
					}
				});

				// å½“ç¦»å¼€èŠå¤©å®¤é¡µé¢æ—¶æ–­å¼€è¿æ¥
				window.swup.hooks.on('visit:start', () => {
					if (window.chatWs && window.chatWs.readyState !== WebSocket.CLOSED) {
						window.chatWs.close();
						console.log('ç¦»å¼€èŠå¤©å®¤ï¼Œæ–­å¼€è¿æ¥');
					}
				});
			}
		});
	}
</script>

<style>
	/* æ¶ˆæ¯è¿›å…¥åŠ¨ç”» */
	@keyframes fadeInUp {
		from {
			opacity: 0;
			transform: translateY(10px);
		}
		to {
			opacity: 1;
			transform: translateY(0);
		}
	}

	.animate-fadeInUp {
		animation: fadeInUp 0.3s ease-out;
	}

	/* æ¨¡æ€æ¡†æ·¡å‡ºåŠ¨ç”» */
	@keyframes fadeOut {
		from {
			opacity: 1;
		}
		to {
			opacity: 0;
		}
	}

	/* é”™è¯¯æŠ–åŠ¨åŠ¨ç”» */
	@keyframes shake {
		0%, 100% { transform: translateX(0); }
		10%, 30%, 50%, 70%, 90% { transform: translateX(-10px); }
		20%, 40%, 60%, 80% { transform: translateX(10px); }
	}

	/* è„‰å†²åŠ¨ç”»ï¼ˆç”¨äºæ–°æ¶ˆæ¯æç¤ºï¼‰ */
	@keyframes pulse {
		0%, 100% { opacity: 1; }
		50% { opacity: 0.5; }
	}

	/* å¼¹æ€§è¿›å…¥åŠ¨ç”» */
	@keyframes bounceIn {
		0% {
			opacity: 0;
			transform: scale(0.3);
		}
		50% {
			opacity: 1;
			transform: scale(1.05);
		}
		70% {
			transform: scale(0.9);
		}
		100% {
			opacity: 1;
			transform: scale(1);
		}
	}

	/* æ»‘å…¥åŠ¨ç”»ï¼ˆç”¨æˆ·åˆ—è¡¨ï¼‰ */
	@keyframes slideInLeft {
		from {
			opacity: 0;
			transform: translateX(-20px);
		}
		to {
			opacity: 1;
			transform: translateX(0);
		}
	}

	/* æ¸å˜èƒŒæ™¯åŠ¨ç”» */
	@keyframes gradientShift {
		0% { background-position: 0% 50%; }
		50% { background-position: 100% 50%; }
		100% { background-position: 0% 50%; }
	}

	/* æ»šåŠ¨æ¡æ ·å¼ */
	#messages::-webkit-scrollbar,
	#user-list::-webkit-scrollbar {
		width: 6px;
	}

	#messages::-webkit-scrollbar-track,
	#user-list::-webkit-scrollbar-track {
		background: transparent;
	}

	#messages::-webkit-scrollbar-thumb,
	#user-list::-webkit-scrollbar-thumb {
		background: var(--primary);
		border-radius: 3px;
	}

	#messages::-webkit-scrollbar-thumb:hover,
	#user-list::-webkit-scrollbar-thumb:hover {
		background: var(--primary);
		opacity: 0.8;
	}

	/* ç”¨æˆ·åˆ—è¡¨é¡¹åŠ¨ç”» */
	.user-item {
		animation: slideInLeft 0.3s ease-out;
		transition: all 0.2s ease;
	}

	.user-item:hover {
		transform: translateX(4px);
		background: var(--btn-regular-bg-hover) !important;
	}

	/* æŒ‰é’®ç‚¹å‡»æ•ˆæœå¢å¼º */
	button:active {
		transform: scale(0.95);
	}

	/* è¾“å…¥æ¡†ç„¦ç‚¹æ•ˆæœ */
	input:focus {
		box-shadow: 0 0 0 3px var(--primary) / 0.15 !important;
		border-color: var(--primary) !important;
	}

	/* æ¶ˆæ¯æ°”æ³¡æ‚¬åœæ•ˆæœ */
	.message-bubble:hover {
		transform: translateY(-1px);
		box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
	}

	/* æ¨¡æ€æ¡†å¡ç‰‡åŠ¨ç”» */
	.card-base {
		animation: bounceIn 0.4s ease-out;
	}

	/* è¿æ¥çŠ¶æ€æŒ‡ç¤ºå™¨åŠ¨ç”» */
	#connection-status {
		transition: all 0.3s ease;
	}

	#connection-status.text-green-500 {
		animation: pulse 2s infinite;
	}

	/* å‘é€æŒ‰é’®åŠ è½½çŠ¶æ€ */
	#send-btn:disabled {
		cursor: not-allowed;
		opacity: 0.5;
	}

	/* æ¶ˆæ¯æ°”æ³¡æ ·å¼ä¼˜åŒ– */
	#messages > div {
		transition: opacity 0.3s ease;
	}

	#messages > div:hover {
		opacity: 1 !important;
	}

	/* å¹³æ»‘æ»šåŠ¨ */
	#messages {
		scroll-behavior: smooth;
	}

	/* ç”¨æˆ·åˆ—è¡¨æ ‡é¢˜åŠ¨ç”» */
	#user-list > .user-item:first-child {
		animation-delay: 0.1s;
	}

	#user-list > .user-item:nth-child(2) {
		animation-delay: 0.2s;
	}

	#user-list > .user-item:nth-child(3) {
		animation-delay: 0.3s;
	}

	/* é”™è¯¯æç¤ºåŠ¨ç”» */
	#password-error {
		animation: fadeInUp 0.3s ease-out;
	}

	/* å“åº”å¼ä¼˜åŒ– */
	@media (max-width: 1024px) {
		#user-list {
			max-height: 150px;
		}
	}
</style>
