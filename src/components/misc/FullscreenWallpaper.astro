---
import { siteConfig } from "../../config";
// import { Image } from "astro:assets";
import type { FullscreenWallpaperConfig } from "../../types/config";

interface Props {
	config: FullscreenWallpaperConfig;
	className?: string;
}

const { config, className } = Astro.props;

// 获取当前设备类型的图片源
const getImageSources = async () => {
	let srcConfig = config.src;

	// 如果启用了图片API，使用API图片
	// Wallpaper image API is not used here; runtime allowlist handles remote random URLs.


	const toArray = (src: string | string[] | undefined): string[] => {
		if (Array.isArray(src)) return src;
		if (typeof src === "string") return [src];
		return [];
	};
	if (
		typeof srcConfig === "object" &&
		srcConfig !== null &&
		!Array.isArray(srcConfig) &&
		("desktop" in srcConfig || "mobile" in srcConfig)
	) {
		const srcObj = srcConfig as {
			desktop?: string | string[];
			mobile?: string | string[];
		};
		const desktop = toArray(srcObj.desktop);
		const mobile = toArray(srcObj.mobile);
		return {
			desktop: desktop.length > 0 ? desktop : mobile,
			mobile: mobile.length > 0 ? mobile : desktop,
		};
	}
	// 如果是字符串或字符串数组，同时用于桌面端和移动端
	const allImages = toArray(srcConfig as string | string[]);
	return {
		desktop: allImages,
		mobile: allImages,
	};
};

const imageSources = await getImageSources();
const hasDesktopImages = imageSources.desktop.length > 0;
const hasMobileImages = imageSources.mobile.length > 0;

// 如果没有任何图片源，不渲染
if (!hasDesktopImages && !hasMobileImages) {
	return null;
}

// 轮播相关逻辑
const isCarouselEnabled =
	config.carousel?.enable &&
	(imageSources.desktop.length > 1 || imageSources.mobile.length > 1);
const carouselInterval = config.carousel?.interval || 5;

// 样式相关
const position = config.position || "center";
const zIndex = config.zIndex || -1;
const opacity = config.opacity || 0.8;
const blur = config.blur || 0;

// 生成位置类名
const getPositionClass = (pos: string) => {
	switch (pos) {
		case "top":
			return "object-top";
		case "bottom":
			return "object-bottom";
		default:
			return "object-center";
	}
};

const positionClass = getPositionClass(position);
---

<div 
	class:list={[
		"fixed inset-0 w-full h-full overflow-hidden pointer-events-none",
		className
	]}
	style={`z-index: ${zIndex}; opacity: ${opacity};`}
	data-fullscreen-wallpaper
>
<script is:inline>
// 根据 localStorage 立即设置全屏壁纸初始显示状态，避免闪烁
(function() {
	const wallpaperMode = localStorage.getItem('wallpaperMode') || 'banner';
	const fullscreenWallpaper = document.currentScript.parentElement;
	if (wallpaperMode !== 'fullscreen') {
		fullscreenWallpaper.style.display = 'none';
	}
})();
</script>
	<script is:inline define:vars={{ wallpaperSrc: config.src, imageHostAllowlist: siteConfig.imageHostAllowlist || [] }}>
		(function() {
			const allowlist = Array.isArray(imageHostAllowlist) ? imageHostAllowlist : [];

			function toArray(src) {
				if (Array.isArray(src)) return src;
				if (typeof src === "string") return [src];
				return [];
			}

			function collectUrls(src) {
				if (src && typeof src === "object" && !Array.isArray(src)) {
					const desktop = toArray(src.desktop);
					const mobile = toArray(src.mobile);
					return desktop.concat(mobile);
				}
				return toArray(src);
			}

			function isAllowed(url) {
				try {
					const u = new URL(url, window.location.origin);
					return allowlist.some((host) => u.host === host || u.host.endsWith("." + host));
				} catch (_e) {
					return false;
				}
			}

			function withCacheBuster(url, suffix) {
				const joiner = url.includes("?") ? "&" : "?";
				return `${url}${joiner}cb=${Date.now()}-${suffix}`;
			}

		function pick(list, index) {
			if (!list.length) return "";
			if (list.length === 1) return list[0];
			return list[index % list.length];
		}

		function preloadAndSwap(img, url) {
			const preloader = new Image();
			preloader.onload = () => {
				img.src = url;
			};
			preloader.onerror = () => {
				img.src = url;
			};
			preloader.src = url;
		}

		function applyRandomWallpaper() {
			const mode = localStorage.getItem("wallpaperMode") || "banner";
			if (mode !== "fullscreen") return;

			const urls = collectUrls(wallpaperSrc).filter(Boolean);
			const allowed = urls.filter(isAllowed);
			if (!allowed.length) return;

			const container = document.querySelector("[data-fullscreen-wallpaper]");
			if (!container) return;
			const imgs = container.querySelectorAll("img");
			if (!imgs.length) return;

			const prevOpacity = (container as HTMLElement).style.opacity;
			const prevTransition = (container as HTMLElement).style.transition;
			(container as HTMLElement).style.transition = "opacity 0.2s ease";
			(container as HTMLElement).style.opacity = "0";

			imgs.forEach((img, idx) => {
				const src = pick(allowed, idx + Math.floor(Math.random() * allowed.length));
				if (!src) return;
				preloadAndSwap(img, withCacheBuster(src, idx));
			});

			requestAnimationFrame(() => {
				(container as HTMLElement).style.opacity = prevOpacity || "1";
				(container as HTMLElement).style.transition = prevTransition || "";
			});
		}

		if (document.readyState === "loading") {
			document.addEventListener("DOMContentLoaded", applyRandomWallpaper);
		} else {
			applyRandomWallpaper();
		}

		// 当壁纸模式切换到 fullscreen 时再尝试替换
		window.addEventListener("wallpaper-mode-change", (e) => {
			const mode = e.detail?.mode || localStorage.getItem("wallpaperMode") || "banner";
			if (mode === "fullscreen") {
				applyRandomWallpaper();
			}
		});
		})();
	</script>

	<!-- 桌面端壁纸 -->
	{hasDesktopImages && (
		<div class="hidden lg:block w-full h-full relative">
			{imageSources.desktop.map((src, index) => {
				const isLocal = !src.startsWith("http");
				const imageClass = `absolute inset-0 w-full h-full object-cover transition-opacity duration-1000 ${positionClass}`;
				
				if (isLocal) {
					// 对于本地图片，使用img标签而不是Image组件
					return (
						<img
							src={src}
							alt={`Desktop wallpaper ${index + 1}`}
							class={imageClass}
							data-carousel-item={isCarouselEnabled ? index : undefined}
							loading="lazy"
							decoding="async"
							fetchpriority="low"
							style={blur > 0 ? `filter: blur(${blur}px);` : undefined}
						/>
					);
				} else {
					return (
						<img
							src={src}
							alt={`Desktop wallpaper ${index + 1}`}
							class={imageClass}
							data-carousel-item={isCarouselEnabled ? index : undefined}
							loading="lazy"
							decoding="async"
							fetchpriority="low"
							style={blur > 0 ? `filter: blur(${blur}px);` : undefined}
						/>
					);
				}
			})}
		</div>
	)}

	<!-- 移动端壁纸 -->
	{hasMobileImages && (
		<div class="block lg:hidden w-full h-full relative">
			{imageSources.mobile.map((src, index) => {
				const isLocal = !src.startsWith("http");
				const imageClass = `absolute inset-0 w-full h-full object-cover transition-opacity duration-1000 ${positionClass}`;
				
				if (isLocal) {
					// 对于本地图片，使用img标签而不是Image组件
					return (
						<img
							src={src}
							alt={`Mobile wallpaper ${index + 1}`}
							class={imageClass}
							data-carousel-item={isCarouselEnabled ? index : undefined}
							loading="lazy"
							decoding="async"
							fetchpriority="low"
							style={blur > 0 ? `filter: blur(${blur}px);` : undefined}
						/>
					);
				} else {
					return (
						<img
							src={src}
							alt={`Mobile wallpaper ${index + 1}`}
							class={imageClass}
							data-carousel-item={isCarouselEnabled ? index : undefined}
							loading="lazy"
							decoding="async"
							fetchpriority="low"
							style={blur > 0 ? `filter: blur(${blur}px);` : undefined}
						/>
					);
				}
			})}
		</div>
	)}
</div>

{isCarouselEnabled && (
	<script is:inline define:vars={{ carouselInterval }}>
		// 全屏壁纸轮播逻辑（按需启动，避免重复初始化和隐藏状态下运行）
		(function() {
			const activeIntervals = [];

			function clearCarousels() {
				while (activeIntervals.length) {
					const id = activeIntervals.pop();
					clearInterval(id);
				}
			}

			function initFullscreenWallpaperCarousel() {
				const wallpaperContainer = document.querySelector('[data-fullscreen-wallpaper]');
				if (!wallpaperContainer) return;

				// 避免重复初始化
				if (wallpaperContainer.dataset.carouselReady === 'true') return;

				// 仅在全屏模式下启动
				const mode = localStorage.getItem('wallpaperMode') || 'banner';
				if (mode !== 'fullscreen') return;

				const desktopItems = wallpaperContainer.querySelectorAll('.hidden.lg\\:block [data-carousel-item]');
				const mobileItems = wallpaperContainer.querySelectorAll('.block.lg\\:hidden [data-carousel-item]');

				function startCarousel(items) {
					if (items.length <= 1) return;

					let currentIndex = 0;

					// 初始化：显示第一张，隐藏其他
					items.forEach((item, index) => {
						item.style.opacity = index === 0 ? '1' : '0';
					});

					const id = setInterval(() => {
						items[currentIndex].style.opacity = '0';
						currentIndex = (currentIndex + 1) % items.length;
						items[currentIndex].style.opacity = '1';
					}, carouselInterval * 1000);

					activeIntervals.push(id);
				}

				if (desktopItems.length > 0) {
					startCarousel(desktopItems);
				}
				if (mobileItems.length > 0) {
					startCarousel(mobileItems);
				}

				wallpaperContainer.dataset.carouselReady = 'true';
			}

			function maybeInit() {
				clearCarousels();
				const wallpaperContainer = document.querySelector('[data-fullscreen-wallpaper]');
				if (wallpaperContainer) {
					delete wallpaperContainer.dataset.carouselReady;
				}
				initFullscreenWallpaperCarousel();
			}

			// 页面加载完成后初始化轮播
			if (document.readyState === 'loading') {
				document.addEventListener('DOMContentLoaded', maybeInit, { once: true });
			} else {
				maybeInit();
			}

			// 监听壁纸模式变化，切换时停止或重新初始化
			window.addEventListener('wallpaper-mode-change', (e) => {
				const mode = e.detail?.mode || localStorage.getItem('wallpaperMode') || 'banner';
				if (mode !== 'fullscreen') {
					clearCarousels();
					const wallpaperContainer = document.querySelector('[data-fullscreen-wallpaper]');
					if (wallpaperContainer) {
						delete wallpaperContainer.dataset.carouselReady;
					}
				} else {
					maybeInit();
				}
			});

			// 页面隐藏/显示时暂停或恢复
			document.addEventListener('visibilitychange', () => {
				const mode = localStorage.getItem('wallpaperMode') || 'banner';
				if (document.hidden || mode !== 'fullscreen') {
					clearCarousels();
					const wallpaperContainer = document.querySelector('[data-fullscreen-wallpaper]');
					if (wallpaperContainer) {
						delete wallpaperContainer.dataset.carouselReady;
					}
					return;
				}
				maybeInit();
			});
		})();
	</script>
)}
